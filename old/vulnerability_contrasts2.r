server=TRUE
if (server){
  wd <- "//10.0.0.5/data2$//BN vulnerability/Full Process/"
}else{
  wd <- "C:/Users/lfortini/Dropbox/USGS/Science/0-ongoing/VAs/HI spp VA/Conceptual model/2- implementation (mine)/Full Process/"}
setwd(wd)

all_combined_file="results/all_combined.csv"
data=read.csv(all_combined_file, stringsAsFactors=FALSE)

#graph order is dangerous: it must reflect exactly the number of factors included in the anova and plot data, or else miss labels will occur

#temp.data=read.csv("Anova.csv", stringsAsFactors=FALSE)
min_n_per_group=20

Transform_anova_and_tukey <- function(group, data, min_n_per_group,plot_name=NULL, factor_order=NULL, tilt=NULL, labels=NULL) {
  anova_results_mat=c()
  Tukey_results=c()
  group=as.factor(group)
  temp.data=data.frame(group)
  temp.data=cbind(temp.data, data)  
  temp.data0=temp.data
  jnk=temp.data[,1]
  unique.Dataset=unique(jnk)
  n.unique.Dataset=length(unique.Dataset)
  for (jj in 1:n.unique.Dataset){ 
    jnk2=which(temp.data[,1]==unique.Dataset[jj])
    if (length(jnk2)<min_n_per_group){
      temp.data=temp.data[-jnk2,]
    }  
  }
  jnk=temp.data[,1]
  unique.Dataset=unique(jnk)
  n.unique.Dataset=length(unique.Dataset)
  temp.data[,2]=as.double(temp.data[,2])
  #temp.data[,1]=factor(temp.data[,1])
  
  data_available=0
  transformed=0
  transform.log=0
  transform.sqrt=0
  transform.cbrt=0
  transform.further=0
  
  n =1
  for (n in 1:n.unique.Dataset){        
    temp.data5=as.double(temp.data[temp.data[,1]==unique.Dataset[n],2])
    jnk=shapiro.test(temp.data5)
    if (jnk$p.value<=0.05){
      transform.log=1
      break} 
    else {transformed=0}   
  }
  
  if (transform.log==1) {
    for (n in 1:n.unique.Dataset){         
      temp.data5=as.double(temp.data[temp.data[,1]==unique.Dataset[n],2])
      temp.data5=log(temp.data5+1)
      jnk=shapiro.test(temp.data5)
      if (jnk$p.value<=0.05){
        transform.sqrt=1
        break
      } else {
        transformed=1
      }
    }
  }
  
  if (transform.sqrt==1) {
    for (n in 1:n.unique.Dataset){         
      temp.data5=as.double(temp.data[temp.data[,1]==unique.Dataset[n],2])
      temp.data5=sqrt(temp.data5)
      jnk=shapiro.test(temp.data5)
      if (jnk$p.value<=0.05){
        transform.cbrt=1
        break
      }else {transformed=2}
    }
  }
  
  if (transform.cbrt==1) {
    for (n in 1:n.unique.Dataset){         
      temp.data5=as.double(temp.data[temp.data[,1]==unique.Dataset[n],2])
      temp.data5=(temp.data5)^(1/3)
      jnk=shapiro.test(temp.data5)
      if (jnk$p.value<=0.05){transformed=4
                             break} 
      else {transformed=3}
    }
  }
  
  if (transformed==1){temp.data[,2]=log(temp.data[,2]+1)} 
  if (transformed==2){temp.data[,2]=sqrt(temp.data[,2])} 
  if (transformed==3){temp.data[,2]=(temp.data[,2])^(1/3)} 
  if (transformed==4){temp.data[,2]=rank(temp.data[,2],ties.method="average")}
  
  if (n.unique.Dataset>1){
    dimnames(temp.data)[[2]]<- c( "Group", "Data")
    temp.data=data.frame(temp.data)
    temp.data$Group=factor(temp.data$Group)
    anova_results=aov(Data~Group,data=temp.data)
    anova_results2=anova(anova_results)
    anova_results2=anova_results2[1, ]
    anova_significance=anova_results2[1,"Pr(>F)"]
    significant=anova_significance[1]<=0.05
    
    anova_results_mat=cbind(transformed,anova_results2)
    if (significant==1) {
      if (n.unique.Dataset>2){
        Tukey_results=TukeyHSD(anova_results,"Group")
        Tukey_results=Tukey_results$Group
      }
    }  
  }
  if (!is.null(plot_name)){
    jpeg_name=paste("comparisons/", plot_name,".jpeg", sep="")
    jpeg(jpeg_name,
         width = 6, height = 6, units = "in",
         pointsize = 12, quality = 90, bg = "white", res = 300)
    
    if (!is.null(factor_order)){
      temp.data0[,1]=factor(temp.data0[,1], factor_order)
    }
    
    if (!is.null(tilt)){par(xaxt="n")}
    plot(temp.data0[,1], temp.data0[,2]) #ylab="Angiosperm abundance per sample", xlab="Site", ylim=c(0,ylim_value)
    
    if (!is.null(tilt)){
      if (is.null(labels)){
        lablist.x<-levels(temp.data0[,1])
      }else{
        lablist.x<-labels
      }
      axis(1, at=seq(1, length(lablist.x), by=1), labels = FALSE)
      text(x = seq(1, length(lablist.x), by=1), par("usr")[3] - 0.05, labels = lablist.x, srt = tilt, pos = 1, xpd = TRUE)
    }
    dev.off()
    
    if (significant==1) {
      jpeg_name=paste("comparisons/", plot_name,"_Tukey.jpeg", sep="")
      jpeg(jpeg_name,
           width = 6, height = 6, units = "in",
           pointsize = 12, quality = 90, bg = "white", res = 300)
      par(mar=c(2.1, 15.1, 2.1, 2.1))
      #par(xpd=FALSE)
      plot(TukeyHSD(anova_results,"Group"), las=1) #ylab="Angiosperm abundance per sample", xlab="Site", ylim=c(0,ylim_value)
      
      dev.off()
      
      jpeg_name=paste("comparisons/", plot_name,"_grouped_treatments.jpeg", sep="")
      jpeg(jpeg_name,
           width = 8, height = 8, units = "in",
           pointsize = 12, quality = 90, bg = "white", res = 300)
      library(multcomp)
      tuk <- glht(anova_results, linfct = mcp(Group = "Tukey"))
      summary(tuk)          # standard display
      tuk.cld <- cld(tuk)   # letter-based display
      opar <- par(mai=c(1,1,1.5,1))
      
      par(oma = c(6, 0, 0, 0))#if (!is.null(tilt)){par(xaxt="n")}
      plot(tuk.cld, las=3, xlab="")#, axis(1, las=3)) # ; axis(1, las=3); 
      par(opar)
      dev.off()
      
    }
  }
  #summary stats  
  summary_stats=tapply(temp.data0[,2], temp.data0[,1], mean, na.rm = TRUE)
  summary_stats=rbind(summary_stats,tapply(temp.data0[,2], temp.data0[,1], function(x) length(unique(x))))
  summary_stats=rbind(summary_stats,tapply(temp.data0[,2], temp.data0[,1], sd, na.rm = TRUE))
  summary_stats=rbind(summary_stats, tapply(temp.data0[,2], temp.data0[,1], median, na.rm = TRUE))
  row.names(summary_stats)=c("mean", "count", "standard deviation", "median")
  summary_stats=t(summary_stats)
  summary_stats=summary_stats[order(summary_stats[,1], decreasing = TRUE),]
  csv_name=paste("comparisons/", plot_name,"_summary_stats.csv", sep="")
  write.csv(summary_stats, csv_name, row.names=TRUE)
  csv_name=paste("comparisons/", plot_name,"_anova_mat.csv", sep="")
  write.csv(anova_results_mat, csv_name, row.names=TRUE)
  csv_name=paste("comparisons/", plot_name,"_Tukey_mat.csv", sep="")
  write.csv(Tukey_results, csv_name, row.names=TRUE)  
  return(list(anova_results_mat, Tukey_results))
}

#DEBUG
# group=data$Status.simplified
# data=data$transformed
# min_n_per_group
# plot_name="Conservation_status"
# factor_order=NULL
# tilt=10
# labels=NULL
 
temp_res=Transform_anova_and_tukey(data$Native.Status, data$transformed, min_n_per_group,plot_name="Native_status", factor_order=NULL, tilt=NULL, labels=NULL)
assign("anova_results_mat", temp_res[[1]])
assign("Tukey_results", temp_res[[2]])

ordered_factors=c("Apparently Secure", "Vulnerable", "Rare", "Endangered", "Extinct")
temp_res=Transform_anova_and_tukey(data$Status.simplified, data$transformed, min_n_per_group=min_n_per_group,plot_name="Conservation_status", factor_order=ordered_factors, tilt=10, labels=NULL)
assign("anova_results_mat", temp_res[[1]])
assign("Tukey_results", temp_res[[2]])

temp_res=Transform_anova_and_tukey(data$DIVISION, data$transformed, min_n_per_group,plot_name="Division",factor_order=NULL, tilt=NULL, labels=NULL)
assign("anova_results_mat", temp_res[[1]])
assign("Tukey_results", temp_res[[2]])

temp_res=Transform_anova_and_tukey(data$FAMILY, data$transformed, min_n_per_group,plot_name="Family", factor_order=NULL, tilt=90, labels=NULL)
assign("anova_results_mat", temp_res[[1]])
assign("Tukey_results", temp_res[[2]])

temp_res=Transform_anova_and_tukey(data$GENUS, data$transformed, min_n_per_group,plot_name="Genus", factor_order=NULL, tilt=10, labels=NULL)
assign("anova_results_mat", temp_res[[1]])
assign("Tukey_results", temp_res[[2]])

temp_res=Transform_anova_and_tukey(data$Pioneer, data$transformed, min_n_per_group,plot_name="Pioneer", factor_order=NULL, tilt=NULL, labels=NULL)
assign("anova_results_mat", temp_res[[1]])
assign("Tukey_results", temp_res[[2]])

temp_res=Transform_anova_and_tukey(data$Alien_hab_comp, data$transformed, min_n_per_group,plot_name="Alien_hab_compatibility", factor_order=NULL, tilt=NULL, labels=NULL)
assign("anova_results_mat", temp_res[[1]])
assign("Tukey_results", temp_res[[2]])

temp_res=Transform_anova_and_tukey(data$Coastal, data$transformed, min_n_per_group,plot_name="Coastal", factor_order=NULL, tilt=NULL, labels=NULL)
assign("anova_results_mat", temp_res[[1]])
assign("Tukey_results", temp_res[[2]])


#by cover type
#by most dominant
#ordered_factors=c( 'Evergreen_shrubland', 'Dry_forest', 'Mesic_forest', 'Wet_mesic_forest', 'Decidious_shrubland', 'Alpine_shrubland', 'Dry_shrubland', 'Wet_forest', 'Perennial_grassland')
data_temp=data
to_del=which(data_temp$dominant_cover=='na')
data_temp=data_temp[-to_del,]
ordered_factors=c('Evergreen_shrubland', 'Mesic_forest',  'Dry_forest',  'Decidious_shrubland', 'Wet_mesic_forest', 'Dry_shrubland', 'Perennial_grassland', 'Wet_forest')
temp_res=Transform_anova_and_tukey(data_temp$dominant_cover, data_temp$transformed, min_n_per_group,plot_name="dominant_cover", factor_order=ordered_factors, tilt=20, labels=NULL)
assign("anova_results_mat", temp_res[[1]])
assign("Tukey_results", temp_res[[2]])


#by cover type
#by most prevalent
ordered_factors=c( 'Evergreen_shrubland', 'Dry_forest', 'Mesic_forest', 'Wet_mesic_forest', 'Decidious_shrubland', 'Alpine_shrubland', 'Dry_shrubland', 'Wet_forest', 'Perennial_grassland')
temp_res=Transform_anova_and_tukey(data$cover1, data$transformed, min_n_per_group,plot_name="primary_cover", factor_order=ordered_factors, tilt=20, labels=NULL)
assign("anova_results_mat", temp_res[[1]])
assign("Tukey_results", temp_res[[2]])

#by top 3 most prevalent
library(reshape2)
library(plyr)
main_cover_types=c('main_Alpine_shrubland', 'main_Decidious_shrubland', 'main_Dry_forest', 'main_Dry_grassland', 'main_Dry_shrubland', 'main_Evergreen_shrubland', 'main_Mesic_forest', 'main_Mesic_grassland', 'main_Mesic_shrubland', 'main_Perennial_grassland', 'main_Wet_forest', 'main_Wet_mesic_forest', 'main_Wetland_coastal')
cover_ranks=c("cover1","cover2","cover3")
temp_data=data[,c(cover_ranks,"transformed")]
temp_data=melt(temp_data, id=c("transformed"))

ordered_factors=c('Wetland_coastal', 'Alpine_shrubland', 'Evergreen_shrubland', 'Mesic_shrubland', 'Mesic_grassland', 'Decidious_shrubland', 'Dry_forest', 'Mesic_forest', 'Wet_mesic_forest', 'Wet_forest', 'Perennial_grassland', 'Dry_shrubland')
#ordered_factors=c('Wetland_coastal', 'Alpine_shrubland', 'Evergreen_shrubland', 'Mesic_shrubland', 'Mesic_grassland', 'Decidious_shrubland', 'Dry_forest', 'Mesic_forest', 'Wet_mesic_forest', 'Dry_shrubland', 'Wet_forest', 'Perennial_grassland', 'Dry_grassland')
temp_res=Transform_anova_and_tukey(temp_data$value, temp_data$transformed, min_n_per_group,plot_name="primary_3covers", factor_order=ordered_factors, tilt=20, labels=NULL)
assign("anova_results_mat", temp_res[[1]])
assign("Tukey_results", temp_res[[2]])


#by island
islands=c("Ha", "Ma", "Ka", "Oa", "Mo", "La", "Ke", "Ni")
temp_data=data[,c(islands,"transformed")]
island=islands[1]
i=1
for (island in islands){
  jnk=temp_data[,i]
  jnk[jnk>0]=island
  jnk[jnk<=0]="na"
  temp_data[,i]=jnk
  i=i+1  
}
temp_data1=melt(temp_data, id=c("transformed"))
temp_data1=temp_data1[temp_data1$value!="na",]
ordered_factors=c("Ha", "Ma", "Ke", "La", "Mo", "Oa",  "Ka", "Ni")
plot_labels=c("Hawaii", "Maui", "Kahoolawe", "Lanai", "Molokai", "Oahu",  "Kauai", "Nihau")
temp_res=Transform_anova_and_tukey(temp_data1$value, temp_data1$transformed, min_n_per_group,plot_name="islands_by_age", factor_order=ordered_factors, tilt=10, labels=plot_labels)
assign("anova_results_mat", temp_res[[1]])
assign("Tukey_results", temp_res[[2]])

ordered_factors=c("Ha", "Ma", "Oa", "Ka", "Mo", "La",  "Ni", "Ke")
plot_labels=c("Hawaii", "Maui", "Oahu", "Kauai", "Molokai", "Lanai", "Nihau", "Kahoolawe")
temp_res=Transform_anova_and_tukey(temp_data1$value, temp_data1$transformed, min_n_per_group,plot_name="islands_by_size", factor_order=ordered_factors, tilt=10, labels=plot_labels)


#bi island, only single island endemics
islands=c("Ha", "Ma", "Ka", "Oa", "Mo", "La", "Ke", "Ni")
jnk=data[,islands]
jnk[jnk>0]=1
temp_data=cbind(jnk, transformed=data[,"transformed"])
jnk=rowSums(temp_data[,islands])
temp_data=temp_data[jnk==1,]

island=islands[1]
i=1
for (island in islands){
  jnk=temp_data[,i]
  jnk[jnk>0]=island
  jnk[jnk<=0]="na"
  temp_data[,i]=jnk
  i=i+1  
}

ordered_factors=c("Ha", "Ma", "Ke", "La", "Mo", "Oa",  "Ka", "Ni")
plot_labels=c("Hawaii", "Maui", "Kahoolawe", "Lanai", "Molokai", "Oahu",  "Kauai", "Nihau")
temp_data1=melt(temp_data, id=c("transformed"))
temp_data1=temp_data1[temp_data1$value!="na",]
temp_res=Transform_anova_and_tukey(temp_data1$value, temp_data1$transformed, min_n_per_group,plot_name="islands_endemics_only_by_age", factor_order=ordered_factors, tilt=10, labels=plot_labels)
assign("anova_results_mat", temp_res[[1]])
assign("Tukey_results", temp_res[[2]])

ordered_factors=c("Ha", "Ma", "Oa", "Ka", "Mo", "La",  "Ni", "Ke")
plot_labels=c("Hawaii", "Maui", "Oahu", "Kauai", "Molokai", "Lanai", "Nihau", "Kahoolawe")
temp_res=Transform_anova_and_tukey(temp_data1$value, temp_data1$transformed, min_n_per_group,plot_name="islands_endemics_only_by_size", factor_order=ordered_factors, tilt=10, labels=plot_labels)

ordered_factors=c("Ha", "Ma", "Ka", "Mo", "Oa", "La",  "Ni", "Ke")
plot_labels=c("Hawaii", "Maui", "Kauai", "Molokai", "Oahu", "Lanai", "Nihau", "Kahoolawe")
temp_res=Transform_anova_and_tukey(temp_data1$value, temp_data1$transformed, min_n_per_group,plot_name="islands_endemics_only_by_elev", factor_order=ordered_factors, tilt=10, labels=plot_labels)
