library(reshape)
## working directory
server=TRUE
if (server){
  wd <- "//10.0.0.5/data2$//BN vulnerability/Full Process/"
}else{
  wd <- "C:/Users/lfortini/Dropbox/USGS/Science/0-ongoing/VAs/HI spp VA/Conceptual model/2- implementation (mine)/Full Process/"}
setwd(wd)

q2levels <- function(x, q=0.5, lv=c("Low", "High")) {
  y <- quantile(x, q, na.rm=TRUE)  
  y[y==min(x, na.rm = TRUE)]=min(x, na.rm = TRUE)+0.0001
  y[y==max(x, na.rm = TRUE)]=max(x, na.rm = TRUE)-0.0001
  thresholds=y
  quant_data <- rep(lv[1], length(x))
  quant_data[is.na(x)] <- "none"
  quant_data[x > rep(y,length(x))] <- lv[2]
  return(list(quant_data, thresholds))}

#first_and_last_discr_var=c(85:169)
csv_data="results/all_combined.csv"
variables.file="variables.csv"

## load un-categorized data
all_combined <- read.csv(csv_data, stringsAsFactors=FALSE)
#all_combined=all_combined[,-first_and_last_discr_var]

## load the list of variables and corresponding nodes
vlist <- read.csv(variables.file, stringsAsFactors=FALSE)

## remove information for nodes without variables
vlist0 <- vlist[vlist$dependents==TRUE,]
vlist=vlist0$Variable

## simplify all_combined to contain only variables associated with nodes
## (and sp_name and sp_code)
all_combined <- all_combined[, c("sp_name", "sp_code", vlist)]
all_names=names(all_combined)




qrld <- matrix("none", nrow=nrow(all_combined), length(all_names))
qrld <- as.data.frame(qrld, stringsAsFactors=FALSE)
names(qrld) = all_names
qrld$sp_name <- all_combined$sp_name
qrld$sp_code <- all_combined$sp_code

## loop through the model nodes, identify associated variables, categorize
## them as appropriate and store the results in the qrld dataframe

n=3
for (n in 3:length(all_names)) {
  ## if the node has two categories, break it into pieces by the
  b <- 0.5      
  temp_res= q2levels(all_combined[, n], b, c(0, 1))
  assign("quant_data", temp_res[[1]])
  assign("thresholds", temp_res[[2]])
  rm("temp_res")
  qrld[, n] = quant_data 
  rm(quant_data, thresholds, b)    
}
write.csv(qrld, "vuln_syndrome.csv", row.names=FALSE)


